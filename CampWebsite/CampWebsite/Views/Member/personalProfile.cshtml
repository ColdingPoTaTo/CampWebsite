@model CampWebsite.ViewModels.Member3in1ViewModel

@{
    ViewBag.Title = "personalProfile";
    var myProfile = Model.tMember;
    var myOrders = Model.myOrderList;
    var myFavorites = Model.myCampFavorites;
}
<style>
    .imageBox {
        width: auto;
        height: 10rem;
    }

    .image100 {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>


@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="container d-flex justify-content-center mt-5">
        <div class="col-12 col-lg-6 border shadow">
            <ul class="nav nav-pills nav-justified" id="tabSwitch">
                <li class="nav-item"><a class="nav-link " data-bs-toggle="pill" href="#p1Profile">會員資料</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#p2Favorite">我的收藏</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#p3Order" id="tabMyOrders">歷史訂單</a></li>
            </ul>

            <!-- All tabs main div -->
            <div class="tab-content" id="mainContent">
                <!-- Profile tab start                 會員資料頁面-->
                <div class="tab-pane fade active justify-content-center px-5" id="p1Profile">
                    <img class="rounded-circle border border-primary mx-auto d-flex my-2" width="150" height="150" onerror="this.src='/Images/Members/default.jpg'" src=@myProfile.fPhoto />
                    <!-- <h2 class="text-center my-3">The Providers</h2> -->
                    <label class="btn btn-info mx-auto btn-sm d-flex col-2">
                        <input id="ChangePic" style="display:none;" type="file" accept="image/*">
                        <i class="fas fa-pen m-auto"></i> 上傳圖片
                    </label>
                    @*<i class="fas fa-pen m-auto"></i>*@
                    <hr />
                    <div class="form-group mt-3">
                        <label for="fName" class="">姓名</label>
                        <input type="text" class="form-control" name="fName" value="@myProfile.fName" required />
                    </div>
                    <div class="form-group mt-3">
                        <label for="fEmail" class="">Email</label>
                        <input type="email" class="form-control" name="fEmail" value="@myProfile.fEmail" disabled readonly />
                    </div>
                    <div class="form-group mt-3">
                        <label for="fPassword" class="">密碼</label> <i class="fa-solid fa-eye"></i> <i class="fa-solid fa-eye-slash"></i>
                        <input type="password" class="form-control" name="fPassword" value="@myProfile.fPassword" required />
                    </div>
                    <div class="form-group mt-3">
                        <label for="fPhoneNumber" class="">電話</label>
                        <input type="tel" class="form-control" name="fPhoneNumber" value="@myProfile.fPhoneNumber" maxlength="10" minlength="10" />
                    </div>
                    <div class="form-group mt-3">
                        <label>性別</label>
                        <br />
                        @Html.RadioButtonFor(model => model.tMember.fSex, "0", new { @class = "form-check-input", id = "none" })
                        <label for="none" class="">不表態</label>
                        @Html.RadioButtonFor(model => model.tMember.fSex, "1", new { @class = "form-check-input", id = "male" })
                        <label for="male" class="">男生</label>
                        @Html.RadioButtonFor(model => model.tMember.fSex, "2", new { @class = "form-check-input", id = "female" })
                        <label for="female" class="">女生</label>
                    </div>
                    <div class="form-group mt-3">
                        <label for="name" class="">生日</label>
                        <input type="date" class="form-control" name="fBirthday" value="@ViewBag.Birthday" />

                    </div>
                    <div class="form-group mt-3">
                        <label for="name" class="">會員身分</label>
                        <input type="text" class="form-control" name="fGroup" value="@myProfile.fGroup" />
                    </div>
                    <div class="form-group mt-3">
                        <label for="name" class="">Email驗證</label>
                        <input type="text" class="form-control" name="fVerified" value="@myProfile.fVerified" />
                    </div>
                    <div class="form-group mt-3">
                        <input type="submit" value="儲存修改" class="btn btn-info mx-auto d-flex" />
                    </div>
                    <br />
                    <div class="form-group mt-3">
                        <label for="name" class="">刪除帳號</label><br />
                        <input type="button" class="btn btn-danger btn-sm" name="fAvailable" value="刪除帳號" />
                    </div>
                </div>
                <!-- Favorite tab start                 營區收藏頁面 -->
                <div class="tab-pane fade p-5" id="p2Favorite">
                    <h4 class="text-center">營區收藏</h4>
                    @{
                        if (myFavorites == null)
                        {
                            <h3>目前沒有任何收藏</h3>
                        }
                        else
                        {
                            foreach (var Favorite in myFavorites)
                            {
                                <div class="row justify-content-around">
                                    <div class="card col-10 col-lg-6 my-2">
                                        <div class="imageBox">
                                            <img class="card-img-top image100" alt="@Favorite.fCampsiteName" onerror="this.src='/Images/Campsites/CampDefault.jpg'" src=@Favorite.fPhotoUrl />
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title">@Favorite.fCampsiteName</h5>
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                                                </div>
                                                <p><i class="fa-solid fa-location-dot"></i> @Favorite.fCity</p>
                                            </div>
                                            <div class="d-flex p-3">
                                                @Html.ActionLink("查看住宿", "Details", "CampSite", new { id = Favorite.fCampsiteID }, new { @class = "btn border-success text-center m-auto" })

                                            </div>
                                        </div>
                                    </div>
                                </div>

                            }
                        }
                    }



                </div>
                <!-- Order History tab start                  歷史訂單頁面-->
                <div class="tab-pane fade my-4 justify-content-center px-5" id="p3Order">
                    <h3 class="text-center">歷史訂單</h3>
                    @if (myOrders == null)
                    {
                        <h2>還沒有訂單</h2>
                    }
                    else
                    {
                        foreach (var item in myOrders)
                        {
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between">
                                    <div>
                                        訂單編號: @item.fOrderCode
                                    </div>
                                    <div>
                                        @Html.ActionLink("住宿評語", "OrderDetail", new { OrderCode = item.fOrderCode })
                                    </div>
                                </div>
                                <div class="card-body">
                                    <blockquote class="blockquote mb-0 ">
                                        <div class="d-flex justify-content-between">
                                            <div class="test">
                                                <p>@item.fCampsiteName</p>
                                                <p>入住日期: @item.fCheckinStart</p>
                                                <p>退房日期: @item.fCheckinEnd</p>
                                                <p>@item.fTentCount 個營位</p>
                                            </div>
                                            <div class="">
                                                <p>TWD @item.fTotalPrice</p>
                                                @Html.ActionLink("訂單細節", "OrderDetail", new { OrderCode = item.fOrderCode })
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <footer class="blockquote-footer   ">@(item.fZDay > 0? "再" + item.fZDay + "天就見面囉": "謝謝惠顧" )</footer>
                                        </div>
                                    </blockquote>
                                </div>
                            </div>
                            <br />
                        }
                    }

                </div>
            </div>
        </div>
    </div>
}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    //script for 照片上傳
    $("#ChangePic").change(function () {

        previewImg(this.files);
    });
    function previewImg(files) {
        if (files.length == 0)
            return;
        var file = files[0];
        var fr = new FileReader();
        //註冊：選檔被讀取完成後之事件處理器
        fr.onload =
            function () {
                $('#p1Profile img').attr({ src: fr.result });
                var data = new FormData();
                data.append("UploadedImage", file);
                sendAjax(data);
            };
        fr.readAsDataURL(file);
    }

    function sendAjax(data) {
        var ajaxRequest = $.ajax({
                type: "POST",
                url: "@Url.Action("uploadPersonalPic")",
                    contentType: false,         // 告訴jQuery不要去設置Content-Type
                    processData: false,         // 告訴jQuery不要去處理發送的數據
                    dataType: "json",
                    data: data
            })
                .done(function (data, textStatus) {
                    console.log("會員照片上傳成功");
                })
                .fail(function() {
                    console.log("回傳失敗");
                });
    }
</script>

<script>
    //老師的作法
    //網頁重載後，顯示重載前所顯示的頁籤
    $(function () {
        $('a[data-bs-toggle="pill"]').on("show.bs.tab", function () {
            localStorage.setItem("activeTab", $(this).attr("href"));
            //比較: sessionStorage's item 會在網頁關閉後被移除
        });
        var activeTab = localStorage.getItem("activeTab");
        console.log(activeTab); //activeTab有可能是null
        if (activeTab) {
            $('#tabSwitch a[href="' + activeTab + '"]').tab("show");
        } else {
            $(`#tabSwitch li:eq(0) a`).tab("show");
        }
    });
</script>

