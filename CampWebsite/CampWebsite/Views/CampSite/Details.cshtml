@using CampWebsite.Models
@model Tuple<tCampsite, IEnumerable<tComment>, List<CTags>>
@{ ViewBag.Title = "Details"; }

<div class="d-md-flex carousel mt-5 w-100">
    <div class="col-md-10 carousel-main pe-md-3">
        <img class="w-100 h-100 px-3" id="img_selected" src="~/Images/1.png" alt="">
    </div>
    <div class="col-md-2 carousel-list">
        <div class="img-up fs-3">
            <i class="fas fa-chevron-circle-up"></i>
        </div>
        <div class="img-down fs-3">
            <i class="fas fa-chevron-circle-down"></i>
        </div>
        <div class="img-left fs-3">
            <i class="fas fa-chevron-circle-left"></i>
        </div>
        <div class="img-right fs-3">
            <i class="fas fa-chevron-circle-right"></i>
        </div>
        <div class="d-md-flex flex-md-column justify-content-md-center carousel-sider">
            <div class="img-container d-flex  justify-content-center d-md-block pt-md-3 ps-md-0 ps-2">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/2.png" alt="">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/3.png" alt="">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/1.png" alt="">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/2.png" alt="">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/3.png" alt="">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/1.png" alt="">
                <img class="mb-md-3 me-2 opacity-25" src="~/Images/2.png" alt="">
            </div>
        </div>
    </div>
</div>
<br>
<!-- ======= -->
<div class="row">
    <!-- 資訊、介紹、tags -->
    <div class="d-xl-flex mb-3">
        <div class="col-xl-9">
            <div class="d-flex align-items-center mb-2">
                <h3>@Html.DisplayFor(model => model.Item1.fCampsiteName)</h3>
                <div class="d-flex ms-2">
                    <div class="d-flex align-items-center star-container">
                        @{ int star_avarage_count = 0;
                            for (int i = 0; i < Math.Round(ViewBag.reviews_score, 0); i++)
                            {
                <i class="fas fa-star"></i> star_avarage_count++;
            }
            for (int i = star_avarage_count; i < 5; i++)
            {
<i class="far fa-star"></i> } }
                    </div>
                    <a href="" class="ms-2">顯示評論</a>
                </div>
            </div>
            <div class="d-sm-flex align-items-center justify-content-between border-bottom">
                <div class="d-sm-flex">
                    <p>@Html.DisplayFor(model => model.Item1.fCampsiteCity)@Html.DisplayFor(model => model.Item1.fCampsiteAddress)</p>
                    <a href="" class="ms-sm-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>在地圖上顯示</span>
                    </a>
                </div>
                <div class="text-end">
                    <a href="" class="fs-5 pe-2"><i class="fas fa-heart"></i></a>
                    <a href="" class="fs-5"> <i class="fas fa-share-alt"></i></a>
                </div>
            </div>
            <div class="pe-xl-5 py-3 introduction">
                @Html.DisplayFor(model => model.Item1.fCampsiteIntroduction)
            </div>
        </div>
        <div class="col-xl-3 ps-xl-5 mt-xl-0">
            <div class="d-flex flex-wrap tags-container">
                @{ if (Model.Item3.Count <= 0)
                                {
                    <div>尚無任何標籤</div> }
                                foreach (CTags item in Model.Item3)
                                {<div>@item.fTagName</div>} }
            </div>
        </div>
    </div>
    <div class="fs-3">空位情況</div>
    <!-- 月曆 -->
    <div class="mb-3">
        <div class="calendar-text p-3 mb-3">
            <div class="fs-5">您預計什麼時候入住？</div>
            <div class="d-flex align-items-center my-2">
                <div class="col-4">
                    <div>
                        入住日期 <i class="fas fa-exclamation-circle ms-1 exclamation-start hide-exclamation"></i>
                    </div>
                    <input type="text" value="請選擇" readonly="readonly" class="input_startDate">
                </div>
                <div class="ms-5 col-4">
                    <div>
                        離開日期 <i class="fas fa-exclamation-circle ms-1 exclamation-end hide-exclamation"></i>
                    </div>
                    <input type="text" value="請選擇" readonly="readonly" class="input_endDate">
                </div>
            </div>
            <a href="#tent_wrapper" class="btn btn-secondary w-100" id="gotoTent">查看方案</a>
        </div>
        <div class="calendar">
            <div class="year">
                <span id="pre_year">＜</span>
                <span id="t_year">2022</span>
                <span id="next_year">＞</span>
            </div>
            <div class="month">
                <select name="" id="month">
                    <option value="0">1</option>
                    <option value="1">2</option>
                    <option value="2">3</option>
                    <option value="3">4</option>
                    <option value="4">5</option>
                    <option value="5">6</option>
                    <option value="6">7</option>
                    <option value="7">8</option>
                    <option value="8">9</option>
                    <option value="9">10</option>
                    <option value="10">11</option>
                    <option value="11">12</option>
                </select>
                <span>月</span>
            </div>
            <div class="day">
                <ul>
                    <li>日</li>
                    <li>一</li>
                    <li>二</li>
                    <li>三</li>
                    <li>四</li>
                    <li>五</li>
                    <li>六</li>
                </ul>
            </div>
            <div class="date"></div>
        </div>
    </div>
    <!-- tent -->
    <div class='d-md-flex flex-wrap mb-3'>
        <div class='d-flex justify-content-center col-12 col-md-8'>
            <div class="w-95" id="tent_wrapper">
            </div>
        </div>
        <div class='mt-2 col-12 my-md-0 col-md-4 d-flex justify-content-center'>
            <div class='w-95' id="order_result">
            </div>
        </div>
    </div>
    <!-- 須知 -->
    <div class="p-3 lh-lg mb-3 border-top border-bottom bg-light">
        <div class="d-flex align-items-center mb-50px">
            <div class="d-flex align-items-center notion">
                <i class="fas fa-check"></i>
                <p>入營時間：</p>
            </div>
            <div class="CheckInBar">
                <div class="CheckInTime">
                    <div class="CheckInTimeText">@Html.DisplayFor(model => model.Item1.fCampsiteCheckInTime)以後</div>
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center mb-50px">
            <div class="d-flex align-items-center notion">
                <i class="fas fa-times"></i>
                <p>退營時間：</p>
            </div>
            <div class="CheckInBar">
                <div class="CheckOutTime">
                    <div class="CheckOutTimeText">@Html.DisplayFor(model => model.Item1.fCampsiteCheckOutTime)以前</div>
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <div class="d-flex align-items-center notion">
                <i class="fas fa-mountain"></i>
                <p>海拔：</p>
            </div>
            <span>@Html.DisplayFor(model => model.Item1.fCampsiteAltitude)</span>
        </div>
        <div class="d-flex align-items-center">
            <div class="d-flex align-items-center notion">
                <i class="far fa-calendar-times"></i>
                <p>公休日：</p>
            </div>
            <span>@Html.DisplayFor(model => model.Item1.fCampsiteClosedDay)</span>
        </div>
        <div class="d-flex align-items-center">
            <div class="d-flex align-items-center notion">
                <i class="far fa-calendar-times"></i>
                <p>聯絡營主：</p>
            </div>
            <span>@Html.DisplayFor(model => model.Item1.fCampsitePhone)</span>
        </div>
    </div>
    <!-- 評論 -->
    <div>
        <div class="d-md-flex flex-wrap review-wrapper">
            <div class="col-md-4 col-lg-3 mb-3 review-container">
                <div class="w-95">
                    <div class="h-100 p-3 lh-lg fs-4 d-flex flex-column align-items-center justify-content-around">
                        <p>總評價</p>
                        <p>平均<span>@ViewBag.reviews_score</span>顆星</p>
                        <p>總共<span>@Model.Item2.Count()</span>則評論</p>

                        <div class="d-flex align-items-center star-container fs-4 py-2">
                            @{ for (int i = 0; i < Math.Round(ViewBag.reviews_score, 0); i++)
                                {
                    <i class="fas fa-star"></i> }
                for (int i = star_avarage_count; i < 5; i++)
                {
    <i class="far fa-star"></i> } }
                        </div>
                    </div>
                </div>
            </div>
            <!-- 用戶評論 -->
            @foreach (var item in Model.Item2)
            {
<div class="col-md-4 col-lg-3 mb-3 review-container">
    <div class="w-95">
        <div class="p-3 lh-lg">
            <p>@Html.DisplayFor(model => item.tMember.fName)</p>
            <p>@item.fCommentTime.ToString("yyyy/MM/dd")</p>
            <div class="d-flex align-items-center star-container fs-5 py-2 border-bottom">
                @{ int star_count = 0;
                    for (int i = 0; i < item.fCommentScore; i++)
                    {
    <i class="fas fa-star"></i> star_count++;
}
for (int j = star_count; j < 5; j++)
{<i class="far fa-star"></i> } }
            </div>
            <div class="review-content mt-4 mb-5">
                <p>@Html.DisplayFor(model => item.fComment)</p>
            </div>
            <div class="col-11 btn btn-outline-secondary">看更多</div>
        </div>
    </div>
</div>}
            <!-- =====用戶評論結束 -->
        </div>
    </div>
</div>
<div id="fCampsiteID">@Html.DisplayFor(m => Model.Item1.fCampsiteID)</div>
<div id="test"></div>

<script src="~/Scripts/CampSite.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    //月曆建立
    let month = document.querySelector("#month");
    let t_year = document.querySelector("#t_year");
    let preY = document.querySelector("#pre_year");
    let nextY = document.querySelector("#next_year");
    let date = document.querySelector(".date");
    let now = new Date();
    month.value = now.getMonth();//現在是幾月
    t_year.textContent = now.getFullYear();//現在是幾年
    preY.addEventListener("click", function () {
        t_year.innerHTML = parseInt(t_year.innerHTML) - 1;
    })
    nextY.addEventListener("click", function () {
        t_year.innerHTML = parseInt(t_year.innerHTML) + 1;
    })
    //取得當月第一天是星期幾
    function getDay() {
        let date = new Date(parseInt(t_year.innerHTML), parseInt(month.value), 0);
        let first_day = date.getDay() + 1;
        if (date.getDay() == 8) {
            first_day = 1;
        }
        return first_day;
    }
    //取得當月最後一天是星期幾
    function getLastDay() {
        let date = new Date(parseInt(t_year.innerHTML), parseInt(month.value) + 1, 0);
        let Last_day = date.getDay();
        if (date.getDay() == 8) {
            Last_day = 1;
        }
        return Last_day;
    }
    //取得上月最後一天是幾日
    function getPreDate() {
        let date = new Date(parseInt(t_year.innerHTML), parseInt(month.value), 0);
        return date.getDate();
    }
    //取得當月有幾天
    function getDate() {
        let date = new Date(parseInt(t_year.innerHTML), parseInt(month.value) + 1, 0);
        return date.getDate();
    }
    //建立日
    function addDates() {
        let date_count = 0;
        document.querySelector(".date").innerHTML = ""; //清除dates
        let i = 0;
        let j = 1;
        let d = getDay();
        let PreDate = getPreDate() - d + 1;
        //上月
        for (i; i < getDay(); i++) {
            if (getDay() == 7)
                break;
            while (d != 0) {
                date.innerHTML += `<div class="preMonth"><p>${PreDate}</p><p class="preMonthText"></p></div>`;
                d--;
                PreDate++;
                date_count++;
            }
        }
        //當月
        for (j; j <= getDate(); j++) {
            date.innerHTML += `<div class="thisMonth"><p>${j}</p><p class= "thisMonthText"></p></div>`;
            date_count++;
        }
        //下月
        let firstDate = 1;
        while (date_count < 42) {
            date.innerHTML += `<div class="nextMonth"><p>${firstDate}</p><p class="nextMonthText"></p></div>`;
            firstDate++;
            date_count++;
        }
        //選取範圍跨月
        if (
            new Date(selectedStartDate).getMonth() < month.value ||
            new Date(selectedStartDate).getFullYear() < t_year.textContent
        ) {
            if (IsSelectStart) {
                let SelectedIndexMove = 0;
                SelectedIndexStart = 0;
                for (let i = 0; i < date.children.length; i++) {
                    date.children[i].addEventListener("mouseover", e => {
                        SelectedIndexMove = Array.prototype.indexOf.call(
                            date.children,
                            e.target
                        );
                        if (!IsSelectEnd) {
                            for (let i = SelectedIndexStart; i <= SelectedIndexMove; i++) {
                                date.children[i].classList.add("dateMouse");
                                for (let k = SelectedIndexMove + 1; k < 42; k++)
                                    date.children[k].classList.remove("dateMouse");
                            }
                        }
                    });
                }
            }
        } else {
            IsSelectStart = false;
        }
        GetAjax()
    }
    let id = $("#fCampsiteID").innerHTML;
    $(function () {
        addDates();
    })
    month.addEventListener("change", addDates)
    t_year.addEventListener("DOMNodeInserted", addDates)
    //=====月曆建立結束
    //選取日期範圍的funtion開始
    var SelectedIndexStart = 0;
    var SelectedIndexEnd = 0;
    var IsSelectStart = false;
    var IsSelectEnd = false;
    var selectedStartDate;
    var selectedEndDate;
    var input_startDate = document.querySelector(".input_startDate");
    var input_endDate = document.querySelector(".input_endDate");
    var input_date;
    let exclamation_start = document.querySelector(".exclamation-start");
    let exclamation_end = document.querySelector(".exclamation-end");
    function getSelectedDateTime(e, index) {
        let y =
            month.value == 0 && e.target.classList.contains("preMonth")
                ? parseInt(t_year.textContent) - 1
                : month.value == 11 && e.target.classList.contains("nextMonth")
                    ? parseInt(t_year.textContent) + 1
                    : t_year.textContent;
        let m = e.target.classList.contains("thisMonth")
            ? parseInt(month.value) + 1
            : e.target.classList.contains("preMonth") && month.value == 0
                ? 12
                : e.target.classList.contains("preMonth")
                    ? parseInt(month.value)
                    : e.target.classList.contains("nextMonth") && month.value == 11
                        ? 1
                        : parseInt(month.value) + 2;
        let d = parseInt(date.children[index].firstElementChild.textContent);
        let dd = `${y}/${m}/${d}`;
        input_date = dd;
        dd = new Date(dd).getTime();
        return dd;
    }
    function selectStart(e) {
        SelectedIndexStart = Array.prototype.indexOf.call(date.children, e.target);
        let SelectedIndexMove = 0;
        for (let i = SelectedIndexStart; i < date.children.length; i++) {
            date.children[i].addEventListener("mouseover", e => {
                SelectedIndexMove = Array.prototype.indexOf.call(date.children, e.target);
                if (!IsSelectEnd) {
                    for (let i = SelectedIndexStart; i <= SelectedIndexMove; i++) {
                        date.children[i].classList.add("dateMouse");
                        for (let k = SelectedIndexMove + 1; k < 42; k++)
                            date.children[k].classList.remove("dateMouse");
                    }
                }
            });
        }
        date.children[SelectedIndexStart].classList.add("dateIsSelected");
        selectedStartDate = getSelectedDateTime(e, SelectedIndexStart);
        input_startDate.value = input_date;
        IsSelectStart = true;
    }
    //======選取日期範圍的function結束

    //日期選取範圍的點擊事件開始
    var CheckinDate;
    var CheckoutDate;
    date.addEventListener("click", e => {
        if (IsSelectStart && IsSelectEnd) {
            IsSelectStart = false;
            IsSelectEnd = false;
            for (let i = 0; i < date.children.length; i++) {
                if (date.children[i].classList.contains("dateIsSelected"))
                    date.children[i].classList.remove("dateIsSelected");
                if (date.children[i].classList.contains("dateMouse"))
                    date.children[i].classList.remove("dateMouse");
            }
            input_endDate.value = "請選擇";

        }
        if (!IsSelectStart) {
            selectStart(e);
            input_startDate.value = input_date;
        } else if (!IsSelectEnd) {
            SelectedIndexEnd = Array.prototype.indexOf.call(date.children, e.target);
            selectedEndDate = getSelectedDateTime(e, SelectedIndexEnd);
            input_endDate.value = input_date;
            if (parseInt(selectedStartDate) < parseInt(selectedEndDate)) {
                date.children[SelectedIndexEnd].classList.add("dateIsSelected");
                IsSelectEnd = true;
                //取得入住日、離開日傳到controller
                CheckinDate = document.querySelector(".input_startDate").value;
                CheckoutDate = document.querySelector(".input_endDate").value;
                CheckoutDate = new Date(CheckoutDate);
                CheckoutDate = CheckoutDate.setDate(CheckoutDate.getDate() - 1);
                CheckoutDate = `${new Date(CheckoutDate).getFullYear()}/${new Date(CheckoutDate).getMonth() + 1}/${new Date(CheckoutDate).getDate()}`
                GetAjax();
            } else if (parseInt(selectedStartDate) === parseInt(selectedEndDate)) {
                IsSelectStart = true;
                selectStart(e);
                input_endDate.value = "請選擇";
            } else {
                IsSelectStart = false;
                date.children[SelectedIndexStart].classList.remove("dateIsSelected");
                selectedStartDate = selectedEndDate;
                selectStart(e);
                input_endDate.value = "請選擇";
            }
        }
        //如果已經選擇消除驚嘆號
        if (IsSelectStart) {
            exclamation_start.classList.add("hide-exclamation");
            exclamation_start.classList.remove("show-exclamation");
        }
        if (IsSelectEnd) {
            exclamation_end.classList.add("hide-exclamation");
            exclamation_end.classList.remove("show-exclamation");
        }
    });
    //=====日期選取範圍的點擊事件結束
    // 跳轉到方案的部分，沒選擇完不能跳轉，還要出現驚嘆號
    var gotoTent = document.querySelector("#gotoTent");

    gotoTent.addEventListener("click", e => {
        if (!IsSelectStart || !IsSelectEnd) {
            e.preventDefault();
        }
        if (!IsSelectStart) {
            exclamation_start.classList.remove("hide-exclamation");
            exclamation_start.classList.add("show-exclamation");
        }
        if (!IsSelectEnd) {
            exclamation_end.classList.remove("hide-exclamation");
            exclamation_end.classList.add("show-exclamation");
        }
    });

   //讀取方案的Ajax方法
    var orderArray = [];

    function GetAjax() {
        //取得月曆是幾年幾月，當月有幾天
        var nowMonth = parseInt(month.value) + 1;
        var nowYear = t_year.textContent;
        var nowLastDate = getDate();
        //取得下個月有幾天
        var nextMonthCount = document.querySelectorAll(".nextMonth").length
        //取得上個月有幾天
        var preMonthCount = document.querySelectorAll(".preMonth").length

        $.ajax({
            type: "post",
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            dataType: "json",
            url: "@Url.Action("Details","CampSite")",
            data: {
                "ID": id,
                "nowYear": nowYear,
                "nowMonth": nowMonth,
                "nowLastDate": nowLastDate,
                "preMonthCount": preMonthCount,
                "preMonthLastDate":  parseInt(getPreDate()),
                "nextMonthCount": nextMonthCount,
                "CheckinDate": CheckinDate,
                "CheckoutDate": CheckoutDate,
            },
            success: function (data) {
                console.log(data)
                var thisMonthText = document.querySelectorAll(".thisMonthText");
                var nextMonth = document.querySelectorAll(".nextMonth");
                var nextMonthText = document.querySelectorAll(".nextMonthText");
                var preMonth = document.querySelectorAll(".preMonth");
                var preMonthText = document.querySelectorAll(".preMonthText");
                var totalQuantity = 0;
                //讀取月曆上總數量
                //#region
                //方案總數
                totalQuantity = data.tents.length
                //1.本月總數量======
                //月曆上本月總數量先填上
                for (let i = 0; i < thisMonthText.length; i++) {
                    thisMonthText[i].textContent = totalQuantity;
                }
                //如果有讀取到被訂走的資料更新總數量
                if (data.ThisM_TentsBooked.length > 0) {
                    for (var item in data.ThisM_TentsBooked) {
                        thisMonthText[data.ThisM_TentsBooked[item].fCheckinDate - 1].textContent
                            = totalQuantity - parseInt(data.ThisM_TentsBooked[item].BookedCount);
                    }
                }
                //2.上月總數量======
                //如果有讀取到被訂走的資料，先填上
                if (data.PreM_TentsBooked.length > 0) {
                    for (var item in data.PreM_TentsBooked) {
                        for (let i = 0; i < preMonth.length; i++) {
                            if (data.PreM_TentsBooked[item].fCheckinDate == parseInt(preMonth[i].textContent))
                                preMonthText[i].textContent = totalQuantity - parseInt(data.PreM_TentsBooked[item].BookedCount)
                        }
                    }
                }
                //沒有訂單的那天填上總數量
                for (let i = 0; i < preMonthText.length; i++) {
                    if (preMonthText[i].textContent == "")
                    preMonthText[i].textContent = totalQuantity;
                }
                //3.下月總數量======
                //如果有讀取到被訂走的資料，先填上
                for (var item in data.NextM_TentsBooked) {
                    for (let i = 0; i < nextMonth.length; i++) {
                        if (data.NextM_TentsBooked[item].fCheckinDate == parseInt(nextMonth[i].textContent))
                            nextMonthText[i].textContent = totalQuantity - parseInt(data.NextM_TentsBooked[item].BookedCount);
                    }
                }
                //沒有訂單的那天填上總數量
                for (let i = 0; i < nextMonthText.length; i++) {
                    if (nextMonthText[i].textContent == "")
                        nextMonthText[i].textContent = totalQuantity;
                }
                //#endregion
                //選擇入住日離開日後的讀取方案
                //#region
                //1.列出有不重複方案名稱
                var tentname = data.tents.map(function (item) {
                    return item.fTentName
                })
                var norepeat_tentname = tentname.filter(function (item, index, array) {
                    return array.indexOf(item) === index
                })
                //2.歸類重複方案名稱，抓出各方案的總數量
                var tentsGroupByName = [];
                for (var j in norepeat_tentname) {
                    let array = [];
                    for (var i in data.tents) {
                        if (data.tents[i].fTentName == norepeat_tentname[j]) {
                            array.push(data.tents[i])
                        }
                    }
                    tentsGroupByName.push(array);
                }
                console.log(tentsGroupByName);

                //3.選擇哪幾天?
                //取得兩日期之間的所有日期方法
                var selectedDateArr = [];
                function getDateTime(datestr) {
                    var temp = datestr.split("/");
                    var date = new Date(temp[0], parseInt(temp[1]) - 1, temp[2]);
                    return date;
                }
                var startTime = getDateTime(CheckinDate);
                var endTime = getDateTime(CheckoutDate);
                while ((endTime.getTime() - startTime.getTime()) >= 0) {
                    var year = startTime.getFullYear();
                    var month = parseInt(startTime.getMonth()) + 1;
                    var day = startTime.getDate();
                    selectedDateArr.push(year + "/" + month + "/" + day);
                    startTime.setDate(startTime.getDate() + 1);
                }
                /*console.log(selectedDateArr)*/

                //4.依照選擇日期、方案名稱，列出每天可訂的tentId
                var tentsGroupByName_remain = [];
                for (var date in selectedDateArr) {
                    var arrayA = [];
                    arrayA.push(selectedDateArr[date])
                    for (var name in tentsGroupByName) {
                        let arrayB = [];
                        arrayB.push(tentsGroupByName[name][0].fTentName);
                        arrayB.push(tentsGroupByName[name][0].fTentCategory);
                        arrayB.push(tentsGroupByName[name][0].fTentPeople);
                        if (new Date(selectedDateArr[date]).getDay() === 0 || new Date(selectedDateArr[date]).getDay() === 6)//假日價格
                            arrayB.push(tentsGroupByName[name][0].fTentPriceWeekend);
                        else//平日價格
                            arrayB.push(tentsGroupByName[name][0].fTentPriceWeekday);
                        let arrayC = [];
                        for (var id in tentsGroupByName[name]) {
                            arrayC.push(tentsGroupByName[name][id].fTentId);
                        }
                        arrayB.push(arrayC);
                        arrayA.push(arrayB);
                    }
                    tentsGroupByName_remain.push(arrayA)
                }
/*                console.log(tentsGroupByName_remain)*/
                //5.找出選擇之日期被訂走的，並從上步驟得來的陣列中刪除
                for (var booked in data.tentsbooked) {
                    for (var date in tentsGroupByName_remain) {
                        if (new Date(tentsGroupByName_remain[date][0]).getTime() === new Date(data.tentsbooked[booked].fCheckinDate_dt).getTime()) {
/*                            console.log("日期相等")*/
                            for (var name in tentsGroupByName_remain[date]) {
/*                                console.log(tentsGroupByName_remain[date][name][0])*/
                                if (tentsGroupByName_remain[date][name][0] === data.tentsbooked[booked].fTentName) {
/*                                    console.log("名字相等")*/
                                    for (var id in tentsGroupByName_remain[date][name][4]) {
                                        if (tentsGroupByName_remain[date][name][4][id] === data.tentsbooked[booked].fTentId) {
                                            {
                                                let del_index = tentsGroupByName_remain[date][name][4].indexOf(data.tentsbooked[booked].fTentId);
                                                tentsGroupByName_remain[date][name][4].splice(del_index,1)
/*                                                console.log("id相等")*/
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                console.log(tentsGroupByName_remain)
                //6.取得這段選擇期間各方案最大可取得數量以及其他資訊
                let min_quantity=0;
                var length = 0;
                var tent_wrapper = document.querySelector("#tent_wrapper");
                var order_result = document.querySelector("#order_result");
                tent_wrapper.innerHTML = "";
                order_result.innerHTML = "";
                for (let j = 1; j < tentsGroupByName_remain[length].length; j++) {
                    min_quantity = tentsGroupByName_remain[length][j][4].length;
                    while (length < tentsGroupByName_remain.length) {
                        if (min_quantity > tentsGroupByName_remain[length][j][4].length)
                            min_quantity = tentsGroupByName_remain[length][j][4].length;
                        length++;
                    }
                    length = 0;

                    let people_icon = "";
                    let tent_number = "";
                    for (let i = 0; i < tentsGroupByName_remain[length][j][2]; i++) {
                        people_icon += "<i class='fas fa-male pe-1'></i>";
                    }
                    for (let i = 0; i <= min_quantity; i++)
                        tent_number += `<option value='${i}'>${i}</option>`
                    tent_wrapper.innerHTML +=
                        "<div class='tent-container p-3'>" +
                        `<h5 class='py-2 border-bottom'>${tentsGroupByName_remain[length][j][0]}</h5>` +
                        `<p class='py-2 border-bottom'>${tentsGroupByName_remain[length][j][1]}</p>` +
                        "<div class='py-2 border-bottom'>" + people_icon +
                        `<span class='ms-2'>適合人數：${tentsGroupByName_remain[length][j][2]}人</span>` +
                        "</div>" +
                        "<div class='py-2 border-bottom'>" +
                    "<span>TWD </span>" +
                    `<span id='tent_select_cost'>${tentsGroupByName_remain[length][j][3] * selectedDateArr.length}</span>` +
                        "</div>" +
                        "<div class='pb-2'>" +
                        "<select name='' id='tent_select_count' class='col-12'>" + tent_number + "</select>" +
                        "</div>" +
                        "<a href='' class='col-12 btn btn-outline-secondary'>查看照片</a>" +
                        "</div>";
                }
                order_result.innerHTML +=
                    "<div class='tent-container p-3 h-100'>" +
                    "<div class='tent-unselected' id='tent_result'>" +
                    "<p id='tent_result_text'></p>" +
                    "<span id='tent_result_cost'></span>" +
                    "</div>" +
                    "<button class='col-12 btn btn-outline-success' id='orderBtn'>現在就預定</button>" +
                    "<ul>" +
                    "<li>只需泡一杯咖啡的時間</li>" +
                    "<li>立即確認</li>" +
                    "<li>不收取訂位手續費</li>" +
                    "</ul>" +
                    "</div>";
                //#endregion
                //印出訂單結果的js
                var tent_result = document.querySelector("#tent_result");
                var tent_result_cost = document.querySelector("#tent_result_cost");
                var orderBtn = document.querySelector("#orderBtn");
                var tent_result_text = document.querySelector("#tent_result_text");
                var tent_select_count = document.querySelectorAll("#tent_select_count");
                tent_wrapper.addEventListener("change", () => {
                    let total_count = 0;
                    let total_cost = 0;
                    for (var count in tent_select_count) {
                        if (tent_select_count[count].value > 0) {
                            total_count += parseInt(tent_select_count[count].value);
                            total_cost +=
                                tent_select_count[count].value *
                                tent_select_count[count].parentNode.previousElementSibling.lastChild.textContent;
                        }
                    }
                    tent_result_text.textContent = `${total_count}間帳篷的價格`;
                    tent_result_cost.textContent = `TWD ${total_cost}`;
                    if (total_count == 0) {
                        tent_result.classList.remove("tent-selected");
                        tent_result.classList.add("tent-unselected");
                        orderBtn.textContent = "現在就預定";
                    } else {
                        tent_result.classList.remove("tent-unselected");
                        tent_result.classList.add("tent-selected");
                        orderBtn.textContent = "馬上預定";
                    }
                });
                //下單按鈕
                orderBtn.addEventListener("click", () => {
                    while (length < tentsGroupByName_remain.length) {
                        for (var count in tent_select_count) {
                            if (tent_select_count[count].value > 0) {
                                for (let j = 1; j < tentsGroupByName_remain[length].length; j++) {
                                    if (tentsGroupByName_remain[length][j][0] == tent_select_count[count].parentNode.parentNode.firstChild.textContent) {
                                        let idArray = tentsGroupByName_remain[length][j][4].slice(0, parseInt(tent_select_count[count].value))
                                        for (var id in idArray) {
                                            let object = {};
                                            object.tentID = idArray[id]
/*                                            object.checkinDate = new Date(tentsGroupByName_remain[length][0]);*/
                                            object.checkinDate = tentsGroupByName_remain[length][0]
                                            object.price = tentsGroupByName_remain[length][j][3]
                                            orderArray.push(object);
                                        }
                                    }
                                }
                            }
                        }
                        length++;
                    }
                    length = 0;
                    console.log(orderArray)
                    console.log(JSON.stringify(orderArray))
                    $.ajax({
                        type: "get",
                        async: false,
                        dataType:'html',
                        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
/*                        contentType: "application/json; charset=utf-8",*/
                        url: '@Url.Action("GenerateOrder", "CampOrder")',
                        data: {
                            "orderJson": JSON.stringify(orderArray),
                        },
                        success: function (data) {
                            window.location.href = this.url;
                        },
                        error: function () {
                            alert("失敗");
                        }
                    })
                })
            },
            error: function () {
                alert("Found error when using Ajax!!");
            }
        })
    }
    //傳送到訂單的ajax



</script>

<!--入營退營時間 -->
<script>
    var CheckInTime = document.querySelector(".CheckInTime");
    var CheckOutTime = document.querySelector(".CheckOutTime");
    var CheckInTimeWidth = 264 / 12 * (18 - @Model.Item1.fCampsiteCheckInTime.Substring(0,2))
    var CheckOutTimeWidth = 264 / 12 * (@Model.Item1.fCampsiteCheckOutTime.Substring(0,2) - 6)
    CheckInTime.style.width = CheckInTimeWidth + "px"
    CheckOutTime.style.width = CheckOutTimeWidth + "px";
</script>


